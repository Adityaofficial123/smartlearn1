<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Player - SmartLearn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.youtube.com/iframe_api"></script>
    <link href="https://unpkg.com/cloudinary-video-player/dist/cld-video-player.min.css" rel="stylesheet">
    <script src="https://unpkg.com/cloudinary-video-player/dist/cld-video-player.min.js"></script>
    <style>
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .sidebar-scroll {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 #f7fafc;
        }
        .sidebar-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .sidebar-scroll::-webkit-scrollbar-track {
            background: #f7fafc;
        }
        .sidebar-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 3px;
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
        .lecture-item {
            transition: all 0.2s ease;
        }
        .lecture-item:hover {
            transform: translateX(4px);
        }
        .module-collapse {
            transition: all 0.3s ease;
        }
        .floating-controls {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
        }
        .search-highlight {
            background: yellow;
            padding: 0 2px;
            border-radius: 2px;
        }
        #video-container {
            max-width: 800px;
            margin: auto;
            height: auto;
        }
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            .sidebar.open {
                transform: translateX(0);
            }
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- Enhanced Navigation -->
    <nav class="bg-white shadow-lg fixed w-full z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <button id="sidebar-toggle" class="md:hidden mr-3 p-2 rounded-lg hover:bg-gray-100">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                    <a href="index.html" class="text-2xl font-bold text-blue-600">SmartLearn</a>
                </div>
                <div class="hidden md:flex items-center space-x-8">
                    <a href="index.html" class="text-gray-700 hover:text-blue-600 transition-colors">Home</a>
                    <a href="courses.html" class="text-gray-700 hover:text-blue-600 transition-colors">Courses</a>
                    <a href="my-courses.html" class="text-blue-600 font-semibold">My Learning</a>
                </div>
                <div id="user-info" class="flex items-center space-x-2">
                    <span id="user-name" class="text-gray-700 font-medium"></span>
                    <button id="logout-btn" class="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 transition-colors">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Loading State -->
    <div id="loading" class="pt-20 flex items-center justify-center min-h-screen">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-600 text-lg">Loading course content...</p>
        </div>
    </div>

    <!-- Main Content -->
    <main id="course-player-content" class="pt-16 min-h-screen flex">
        <!-- Enhanced Sidebar -->
        <aside class="sidebar w-full md:w-96 bg-white shadow-xl fixed md:relative z-40 h-screen md:h-auto">
            <!-- Course Header -->
            <div class="p-6 border-b bg-gradient-to-r from-blue-50 to-purple-50">
                <div class="flex items-start justify-between mb-4">
                    <div class="flex-1">
                        <h2 id="course-title" class="text-xl font-bold text-gray-800 mb-2"></h2>
                        <div class="flex items-center text-sm text-gray-600 mb-3">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span id="progress-text">0% Complete</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="progress-bar" class="progress-bar bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    <button id="close-sidebar" class="md:hidden ml-4 p-2 rounded-lg hover:bg-gray-100">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>

                <!-- Search Box -->
                <div class="relative">
                    <input type="text" id="content-search" placeholder="Search lectures and notes..." 
                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <svg class="absolute left-3 top-2.5 w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                    </svg>
                </div>

                <!-- Filter Buttons -->
                <div class="flex space-x-2 mt-3">
                    <button id="filter-all" class="filter-btn active px-3 py-1 text-xs rounded-full bg-blue-100 text-blue-700 font-medium">All</button>
                    <button id="filter-lectures" class="filter-btn px-3 py-1 text-xs rounded-full bg-gray-100 text-gray-600 font-medium">Lectures</button>
                    <button id="filter-notes" class="filter-btn px-3 py-1 text-xs rounded-full bg-gray-100 text-gray-600 font-medium">Notes</button>
                    <button id="filter-completed" class="filter-btn px-3 py-1 text-xs rounded-full bg-gray-100 text-gray-600 font-medium">Completed</button>
                </div>
            </div>

            <!-- Content List -->
            <div id="modules-list" class="sidebar-scroll overflow-y-auto" style="height: calc(100vh - 280px);">
                <!-- Modules will be rendered here -->
            </div>
        </aside>

        <!-- Main Content Area -->
        <section class="flex-1 bg-gray-50 min-h-screen">
            <!-- Floating Controls -->
            <div class="floating-controls fixed top-20 right-6 z-30 flex flex-col space-y-2">
                <button id="toggle-theater" class="p-3 rounded-full shadow-lg hover:shadow-xl transition-all bg-white">
                    <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm0 4a1 1 0 011-1h12a1 1 0 011 1v8a1 1 0 01-1 1H4a1 1 0 01-1-1V8z" clip-rule="evenodd"></path>
                    </svg>
                </button>
                <button id="toggle-fullscreen" class="p-3 rounded-full shadow-lg hover:shadow-xl transition-all bg-white">
                    <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h4a1 1 0 010 2H6.414l2.293 2.293a1 1 0 11-1.414 1.414L5 6.414V8a1 1 0 01-2 0V4zm9 1a1 1 0 010-2h4a1 1 0 011 1v4a1 1 0 01-2 0V6.414l-2.293 2.293a1 1 0 11-1.414-1.414L13.586 5H12zm-9 7a1 1 0 012 0v1.586l2.293-2.293a1 1 0 111.414 1.414L6.414 15H8a1 1 0 010 2H4a1 1 0 01-1-1v-4zm13-1a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 010-2h1.586l-2.293-2.293a1 1 0 111.414-1.414L15 13.586V12a1 1 0 011-1z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>

            <!-- Content Display Area -->
            <div class="p-6 md:p-8">
                <!-- Video Container -->
                <div id="video-container" class="hidden">
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div id="video-header" class="p-6 border-b">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <h3 id="video-title" class="text-2xl font-bold text-gray-800 mb-2"></h3>
                                    <div class="flex items-center space-x-4 text-sm text-gray-600">
                                        <span id="video-duration">Duration: --</span>
                                        <span id="video-module">Module: --</span>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <select id="playback-speed" class="px-3 py-1 border rounded-lg text-sm">
                                        <option value="0.5">0.5x</option>
                                        <option value="0.75">0.75x</option>
                                        <option value="1" selected>1x</option>
                                        <option value="1.25">1.25x</option>
                                        <option value="1.5">1.5x</option>
                                        <option value="2">2x</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div id="video-content" class="relative">
                            <!-- Video player will be inserted here -->
                        </div>
                        <div class="p-6">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <button id="mark-completed-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors font-semibold flex items-center">
                                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                        </svg>
                                        Mark as Completed
                                    </button>
                                    <button id="take-notes-btn" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors font-semibold flex items-center">
                                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
                                        </svg>
                                        Take Notes
                                    </button>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button id="prev-lecture" class="p-2 text-gray-500 hover:text-blue-600 transition-colors">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                        </svg>
                                    </button>
                                    <button id="next-lecture" class="p-2 text-gray-500 hover:text-blue-600 transition-colors">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notes Container -->
                <div id="notes-container" class="hidden">
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="p-6 border-b">
                            <h3 id="notes-title" class="text-2xl font-bold text-gray-800"></h3>
                        </div>
                        <div id="notes-content" class="p-6 prose max-w-none">
                            <!-- Note content will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Welcome Message -->
                <div id="welcome-message" class="text-center py-20">
                    <div class="max-w-2xl mx-auto">
                        <div class="w-32 h-32 bg-gradient-to-br from-blue-100 to-purple-100 rounded-full flex items-center justify-center mx-auto mb-8">
                            <svg class="w-16 h-16 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <h3 class="text-3xl font-bold text-gray-800 mb-4">Welcome to Your Learning Journey</h3>
                        <p class="text-xl text-gray-600 mb-8">Select a lecture or note from the sidebar to begin your course</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                            <div class="p-4 rounded-lg bg-blue-50">
                                <div class="text-2xl mb-2">🎥</div>
                                <p class="text-sm text-gray-600">Watch engaging video lectures</p>
                            </div>
                            <div class="p-4 rounded-lg bg-green-50">
                                <div class="text-2xl mb-2">📝</div>
                                <p class="text-sm text-gray-600">Access comprehensive notes</p>
                            </div>
                            <div class="p-4 rounded-lg bg-purple-50">
                                <div class="text-2xl mb-2">🏆</div>
                                <p class="text-sm text-gray-600">Track your progress</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Note Taking Modal -->
    <div id="notes-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-full overflow-hidden">
            <div class="p-6 border-b flex items-center justify-between">
                <h3 class="text-xl font-bold">Take Notes</h3>
                <button id="close-notes-modal" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            <div class="p-6">
                <textarea id="user-notes" rows="10" class="w-full p-4 border rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Write your notes here..."></textarea>
                <div class="mt-4 flex justify-end">
                    <button id="save-notes" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">Save Notes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="firebase.js"></script>
    <script src="script.js"></script>
    <script>
    // Enhanced Lecture Player JavaScript
    let currentCourse = null;
    let currentModule = -1;
    let currentLecture = -1;
    let searchResults = [];
    let activeFilter = 'all';
    let completedLectures = [];
    let userNotes = {};

    document.addEventListener('DOMContentLoaded', () => {
        // Ensure notes modal is hidden on page load
        const notesModal = document.getElementById('notes-modal');
        if (notesModal) {
            notesModal.classList.add('hidden');
        }

        // Initialize event listeners
        initializeEventListeners();
        waitForAuth();
    });

    function initializeEventListeners() {
        // Sidebar toggle for mobile
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebar = document.querySelector('.sidebar');
        const closeSidebar = document.getElementById('close-sidebar');

        sidebarToggle?.addEventListener('click', () => {
            sidebar.classList.add('open');
        });

        closeSidebar?.addEventListener('click', () => {
            sidebar.classList.remove('open');
        });

        // Search functionality
        const searchInput = document.getElementById('content-search');
        searchInput?.addEventListener('input', handleSearch);

        // Filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const filter = e.target.id.replace('filter-', '');
                setActiveFilter(filter);
            });
        });

        // Floating controls
        document.getElementById('toggle-theater')?.addEventListener('click', toggleTheaterMode);
        document.getElementById('toggle-fullscreen')?.addEventListener('click', toggleFullscreen);

        // Notes modal
        document.getElementById('take-notes-btn')?.addEventListener('click', openNotesModal);
        document.getElementById('close-notes-modal')?.addEventListener('click', closeNotesModal);
        document.getElementById('save-notes')?.addEventListener('click', saveUserNotes);

        // Navigation
        document.getElementById('prev-lecture')?.addEventListener('click', navigateToLecture(-1));
        document.getElementById('next-lecture')?.addEventListener('click', navigateToLecture(1));

        // Keyboard shortcuts
        document.addEventListener('keydown', handleKeyboardShortcuts);
    }

    function waitForAuth() {
        const interval = setInterval(() => {
            if (window.firebaseServicesInitialized && typeof window.db === 'function') {
                clearInterval(interval);
                
                firebase.auth().onAuthStateChanged(function(user) {
                    window.currentUser = user;
                    
                    if (typeof updateAuthUI === 'function') {
                        updateAuthUI(user);
                    }
                    
                    if (user) {
                        initializeLecturePage();
                    } else {
                        showAuthRequired();
                    }
                });
            }
        }, 100);
    }

    function showAuthRequired() {
        const loadingEl = document.getElementById('loading');
        if (loadingEl) {
            loadingEl.innerHTML = `
                <div class="text-center py-20">
                    <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <svg class="w-10 h-10 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">Authentication Required</h2>
                    <p class="text-gray-600 mb-6">Please log in to access this course.</p>
                    <a href="my-courses.html" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors inline-flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Go to My Courses
                    </a>
                </div>
            `;
        }
    }

    async function initializeLecturePage() {
        const urlParams = new URLSearchParams(window.location.search);
        const courseId = urlParams.get('id');
        
        if (!courseId) {
            window.location.href = 'my-courses.html';
            return;
        }

        if (!window.currentUser) {
            showAuthRequired();
            return;
        }

        try {
            // Check enrollment
            const enrollmentSnapshot = await window.db()
                .collection('enrollments')
                .where('userId', '==', window.currentUser.uid)
                .where('courseId', '==', courseId)
                .limit(1)
                .get();

            if (enrollmentSnapshot.empty) {
                showNotEnrolled();
                return;
            }

            // Fetch course data
            const courseDoc = await window.db().collection('courses').doc(courseId).get();
            if (!courseDoc.exists) {
                throw new Error("Course not found");
            }
            
            currentCourse = courseDoc.data();
            loadCompletedLectures(courseId);
            loadUserNotes(courseId);
            
            updateCourseHeader();
            renderEnhancedModules();
            updateProgress();
            
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('course-player-content').classList.remove('hidden');

        } catch (error) {
            showError(error.message);
        }
    }

    function showNotEnrolled() {
        document.getElementById('loading').innerHTML = `
            <div class="text-center py-20">
                <div class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg class="w-10 h-10 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Enrollment Required</h2>
                <p class="text-gray-600 mb-6">You are not enrolled in this course.</p>
                <a href="my-courses.html" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                    Go to My Courses
                </a>
            </div>
        `;
    }

    function showError(message) {
        document.getElementById('loading').innerHTML = `
            <div class="text-center py-20">
                <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg class="w-10 h-10 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-red-600 mb-4">Error Loading Course</h2>
                <p class="text-gray-600 mb-6">${message}</p>
                <a href="my-courses.html" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                    Go Back
                </a>
            </div>
        `;
    }

    function updateCourseHeader() {
        document.getElementById('course-title').textContent = currentCourse.title;
        document.title = `${currentCourse.title} - SmartLearn`;
    }

    function loadCompletedLectures(courseId) {
        const key = `completedLectures_${window.currentUser.uid}_${courseId}`;
        completedLectures = JSON.parse(localStorage.getItem(key) || '[]');
    }

    function loadUserNotes(courseId) {
        const key = `userNotes_${window.currentUser.uid}_${courseId}`;
        userNotes = JSON.parse(localStorage.getItem(key) || '{}');
    }

    function saveCompletedLectures(courseId) {
        const key = `completedLectures_${window.currentUser.uid}_${courseId}`;
        localStorage.setItem(key, JSON.stringify(completedLectures));
    }

    function saveUserNotesToStorage(courseId) {
        const key = `userNotes_${window.currentUser.uid}_${courseId}`;
        localStorage.setItem(key, JSON.stringify(userNotes));
    }

    function renderEnhancedModules() {
        const modulesList = document.getElementById('modules-list');
        if (!modulesList || !currentCourse.modules) return;

        modulesList.innerHTML = '';

        currentCourse.modules.forEach((module, moduleIndex) => {
            const moduleEl = document.createElement('div');
            moduleEl.className = 'border-b border-gray-100 last:border-b-0';

            const lectureCount = module.lectures?.length || 0;
            const noteCount = module.notes?.length || 0;
            const completedInModule = completedLectures.filter(id => id.startsWith(`${moduleIndex}-`)).length;
            const moduleProgress = lectureCount > 0 ? Math.round((completedInModule / lectureCount) * 100) : 0;

            moduleEl.innerHTML = `
                <div class="p-4">
                    <button onclick="toggleModule('module-${moduleIndex}')" 
                            class="w-full text-left flex items-center justify-between py-2 font-semibold text-gray-800 hover:text-blue-600 transition-colors">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 mr-3 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M2 6a2 2 0 002-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path>
                            </svg>
                            <span>${module.title}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded-full">${moduleProgress}%</span>
                            <svg class="w-4 h-4 transform transition-transform module-chevron" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </button>
                    <div id="module-${moduleIndex}" class="module-content hidden mt-2 space-y-3">
                        ${renderLecturesList(module.lectures, moduleIndex)}
                        ${renderNotesList(module.notes, moduleIndex)}
                    </div>
                </div>
            `;

            modulesList.appendChild(moduleEl);
        });

        attachEnhancedEventListeners();
    }

    function renderLecturesList(lectures, moduleIndex) {
        if (!lectures || lectures.length === 0) return '';

        return `
            <div class="lectures-section">
                <h4 class="text-sm font-semibold text-gray-600 mb-2 flex items-center">
                    <svg class="w-4 h-4 mr-2 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2 6a2 2 0 002-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"></path>
                    </svg>
                    Lectures (${lectures.length})
                </h4>
                <div class="space-y-1">
                    ${lectures.map((lecture, lectureIndex) => {
                        const lectureId = `${moduleIndex}-${lectureIndex}`;
                        const isCompleted = completedLectures.includes(lectureId);
                        const isActive = currentModule === moduleIndex && currentLecture === lectureIndex;
                        
                        return `
                            <div class="lecture-item group flex items-center p-3 rounded-lg cursor-pointer transition-all hover:bg-blue-50 hover:shadow-sm ${isActive ? 'bg-blue-100 shadow-md' : ''}"
                                 data-module="${moduleIndex}" data-lecture="${lectureIndex}" data-type="lecture">
                                <div class="flex-shrink-0 mr-3">
                                    ${isCompleted ? 
                                        '<div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center"><svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg></div>' :
                                        '<div class="w-6 h-6 border-2 border-gray-300 rounded-full flex items-center justify-center group-hover:border-blue-400"><svg class="w-3 h-3 text-gray-400 group-hover:text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path></svg></div>'
                                    }
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="text-sm font-medium text-gray-900 truncate">
                                        ${lecture.title}
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        ${lecture.duration || 'Duration not specified'}
                                    </div>
                                </div>
                                <div class="flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }

    function renderNotesList(notes, moduleIndex) {
        if (!notes || notes.length === 0) return '';

        return `
            <div class="notes-section">
                <h4 class="text-sm font-semibold text-gray-600 mb-2 flex items-center">
                    <svg class="w-4 h-4 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4zM18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z"></path>
                    </svg>
                    Notes (${notes.length})
                </h4>
                <div class="space-y-1">
                    ${notes.map((note, noteIndex) => `
                        <div class="note-item group flex items-center p-3 rounded-lg cursor-pointer transition-all hover:bg-green-50 hover:shadow-sm"
                             data-module="${moduleIndex}" data-note="${noteIndex}" data-type="note">
                            <div class="flex-shrink-0 mr-3">
                                <div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center group-hover:bg-green-200">
                                    <svg class="w-3 h-3 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm0 2h12v8H4V6z"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="text-sm font-medium text-gray-900 truncate">
                                    ${note.title}
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    ${note.pdfUrl ? 'PDF Document' : 'Text Note'}
                                </div>
                            </div>
                            <div class="flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity">
                                <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    function attachEnhancedEventListeners() {
        // Lecture click handlers
        document.querySelectorAll('.lecture-item').forEach(item => {
            item.addEventListener('click', () => {
                const moduleIndex = parseInt(item.dataset.module);
                const lectureIndex = parseInt(item.dataset.lecture);
                selectContent(moduleIndex, lectureIndex, 'lecture');
            });
        });

        // Note click handlers
        document.querySelectorAll('.note-item').forEach(item => {
            item.addEventListener('click', () => {
                const moduleIndex = parseInt(item.dataset.module);
                const noteIndex = parseInt(item.dataset.note);
                selectContent(moduleIndex, noteIndex, 'note');
            });
        });
    }

    function selectContent(moduleIndex, itemIndex, type) {
        // Update active states
        document.querySelectorAll('.lecture-item, .note-item').forEach(item => {
            item.classList.remove('bg-blue-100', 'bg-green-100', 'shadow-md');
        });

        if (type === 'lecture') {
            currentModule = moduleIndex;
            currentLecture = itemIndex;
            const activeItem = document.querySelector(`[data-module="${moduleIndex}"][data-lecture="${itemIndex}"]`);
            activeItem?.classList.add('bg-blue-100', 'shadow-md');
            displayEnhancedLecture(moduleIndex, itemIndex);
        } else {
            const activeItem = document.querySelector(`[data-module="${moduleIndex}"][data-note="${itemIndex}"]`);
            activeItem?.classList.add('bg-green-100', 'shadow-md');
            displayEnhancedNote(moduleIndex, itemIndex);
        }

        // Close sidebar on mobile
        document.querySelector('.sidebar').classList.remove('open');
    }

    function displayEnhancedLecture(moduleIndex, lectureIndex) {
        const lecture = currentCourse.modules[moduleIndex].lectures[lectureIndex];
        const module = currentCourse.modules[moduleIndex];
        
        // Hide other containers
        document.getElementById('notes-container').classList.add('hidden');
        document.getElementById('welcome-message').classList.add('hidden');
        
        // Update video header
        document.getElementById('video-title').textContent = lecture.title;
        document.getElementById('video-duration').textContent = `Duration: ${lecture.duration || 'Not specified'}`;
        document.getElementById('video-module').textContent = `Module: ${module.title}`;
        
        // Setup video content
        const videoContent = document.getElementById('video-content');
        videoContent.innerHTML = '';
        
        if (lecture.videoUrl) {
            if (lecture.videoUrl.includes('drive.google.com')) {
                setupGoogleDriveVideo(lecture.videoUrl, videoContent);
            } else if (lecture.videoUrl.includes('res.cloudinary.com')) {
                setupCloudinaryVideo(lecture.videoUrl, videoContent);
            } else if (lecture.videoUrl.includes('youtube.com') || lecture.videoUrl.includes('youtu.be')) {
                setupYouTubeVideo(lecture.videoUrl, videoContent);
            } else {
                setupGenericVideo(lecture.videoUrl, videoContent);
            }
        } else {
            videoContent.innerHTML = `
                <div class="aspect-video bg-gray-100 rounded-lg flex items-center justify-center">
                    <div class="text-center">
                        <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M2 6a2 2 0 002-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"></path>
                        </svg>
                        <p class="text-gray-500">No video available for this lecture</p>
                    </div>
                </div>
            `;
        }
        
        // Setup completion button
        const lectureId = `${moduleIndex}-${lectureIndex}`;
        const isCompleted = completedLectures.includes(lectureId);
        const completeBtn = document.getElementById('mark-completed-btn');
        
        if (isCompleted) {
            completeBtn.innerHTML = `
                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                </svg>
                Completed
            `;
            completeBtn.className = 'bg-green-600 text-white px-6 py-2 rounded-lg font-semibold flex items-center cursor-default';
        } else {
            completeBtn.innerHTML = `
                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                </svg>
                Mark as Completed
            `;
            completeBtn.className = 'bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors font-semibold flex items-center';
            completeBtn.onclick = () => markLectureCompleted(moduleIndex, lectureIndex);
        }
        
        // Show video container
        document.getElementById('video-container').classList.remove('hidden');
        
        // Load user notes for this lecture
        loadLectureNotes(moduleIndex, lectureIndex);
    }

    function setupGoogleDriveVideo(url, container) {
        const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
        if (match && match[1]) {
            const fileId = match[1];
            container.innerHTML = `
                <div class="aspect-video">
                    <iframe src="https://drive.google.com/file/d/${fileId}/preview" 
                            class="w-full h-full rounded-lg" 
                            allow="autoplay" 
                            allowfullscreen>
                    </iframe>
                    
                </div>
            `;
        } else {
            container.innerHTML = `<p class="text-red-600 p-4">Invalid Google Drive URL</p>`;
        }
    }

    function setupCloudinaryVideo(url, container) {
        const cloudName = 'dxwhobraz';
        let publicId = '';
        const match = url.match(/upload\/(?:v\d+\/)?(.+?)(?:\.[a-z0-9]+)?$/i);
        if (match) publicId = match[1];

        container.innerHTML = `
            <div class="aspect-video">
                <video id="cloudinary-player" class="cld-video-player w-full h-full rounded-lg" controls playsinline></video>
            </div>
        `;

        // Initialize Cloudinary player
        if (window.cloudinary) {
            const player = cloudinary.videoPlayer('cloudinary-player', {
                cloud_name: cloudName,
                controls: true,
                autoplay: false,
                width: '100%',
                height: '100%'
            });
            player.source(publicId);
        }
    }

    function setupYouTubeVideo(url, container) {
        let embedUrl = url;
        if (embedUrl.includes('watch?v=')) {
            embedUrl = embedUrl.replace('watch?v=', 'embed/');
        } else if (embedUrl.includes('youtu.be/')) {
            embedUrl = embedUrl.replace('youtu.be/', 'youtube.com/embed/');
        }

        container.innerHTML = `
            <div class="aspect-video">
                <iframe src="${embedUrl}" 
                        class="w-full h-full rounded-lg" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen>
                </iframe>
            </div>
        `;
    }

    function setupGenericVideo(url, container) {
        container.innerHTML = `
            <div class="aspect-video">
                <video controls class="w-full h-full rounded-lg">
                    <source src="${url}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>
        `;
    }

    function displayEnhancedNote(moduleIndex, noteIndex) {
        const note = currentCourse.modules[moduleIndex].notes[noteIndex];
        
        // Hide other containers
        document.getElementById('video-container').classList.add('hidden');
        document.getElementById('welcome-message').classList.add('hidden');
        
        // Update notes content
        document.getElementById('notes-title').textContent = note.title;
        const notesContent = document.getElementById('notes-content');
        
        if (note.pdfUrl) {
            notesContent.innerHTML = `
                <div class="mb-4 flex items-center space-x-4">
                    <a href="${note.pdfUrl}" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                        View PDF
                    </a>
                    <a href="${note.pdfUrl}" download class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 11-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        Download
                    </a>
                </div>
                <div class="border rounded-lg overflow-hidden">
                    <iframe src="${note.pdfUrl}" class="w-full h-96"></iframe>
                </div>
            `;
        } else {
            notesContent.innerHTML = note.content || '<p class="text-gray-500">No content available for this note.</p>';
        }
        
        // Show notes container
        document.getElementById('notes-container').classList.remove('hidden');
    }

    function markLectureCompleted(moduleIndex, lectureIndex) {
        const lectureId = `${moduleIndex}-${lectureIndex}`;
        if (!completedLectures.includes(lectureId)) {
            completedLectures.push(lectureId);
            saveCompletedLectures(new URLSearchParams(window.location.search).get('id'));
            updateProgress();
            renderEnhancedModules();
            
            // Update button state
            const completeBtn = document.getElementById('mark-completed-btn');
            completeBtn.innerHTML = `
                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                </svg>
                Completed
            `;
            completeBtn.className = 'bg-green-600 text-white px-6 py-2 rounded-lg font-semibold flex items-center cursor-default';
            completeBtn.onclick = null;
            
            // Show success notification
            showNotification('Lecture marked as completed!', 'success');
        }
    }

    function updateProgress() {
        if (!currentCourse?.modules) return;
        
        let totalLectures = 0;
        currentCourse.modules.forEach(module => {
            totalLectures += module.lectures?.length || 0;
        });
        
        const progress = totalLectures > 0 ? Math.round((completedLectures.length / totalLectures) * 100) : 0;
        
        document.getElementById('progress-text').textContent = `${progress}% Complete`;
        document.getElementById('progress-bar').style.width = `${progress}%`;
    }

    function handleSearch() {
        const query = document.getElementById('content-search').value.toLowerCase().trim();
        
        if (!query) {
            clearSearchResults();
            return;
        }
        
        searchResults = [];
        
        currentCourse.modules?.forEach((module, moduleIndex) => {
            // Search lectures
            module.lectures?.forEach((lecture, lectureIndex) => {
                if (lecture.title.toLowerCase().includes(query)) {
                    searchResults.push({
                        type: 'lecture',
                        moduleIndex,
                        itemIndex: lectureIndex,
                        title: lecture.title,
                        module: module.title
                    });
                }
            });
            
            // Search notes
            module.notes?.forEach((note, noteIndex) => {
                if (note.title.toLowerCase().includes(query) || 
                    (note.content && note.content.toLowerCase().includes(query))) {
                    searchResults.push({
                        type: 'note',
                        moduleIndex,
                        itemIndex: noteIndex,
                        title: note.title,
                        module: module.title
                    });
                }
            });
        });
        
        highlightSearchResults(query);
    }

    function highlightSearchResults(query) {
        // Remove previous highlights
        document.querySelectorAll('.search-highlight').forEach(el => {
            el.outerHTML = el.innerHTML;
        });
        
        // Add new highlights
        searchResults.forEach(result => {
            const selector = result.type === 'lecture' 
                ? `[data-module="${result.moduleIndex}"][data-lecture="${result.itemIndex}"]`
                : `[data-module="${result.moduleIndex}"][data-note="${result.itemIndex}"]`;
            
            const element = document.querySelector(selector);
            if (element) {
                const titleEl = element.querySelector('.text-sm.font-medium');
                if (titleEl) {
                    const regex = new RegExp(`(${query})`, 'gi');
                    titleEl.innerHTML = titleEl.textContent.replace(regex, '<span class="search-highlight">$1</span>');
                }
            }
        });
    }

    function clearSearchResults() {
        searchResults = [];
        document.querySelectorAll('.search-highlight').forEach(el => {
            el.outerHTML = el.innerHTML;
        });
    }

    function setActiveFilter(filter) {
        activeFilter = filter;
        
        // Update button states
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active', 'bg-blue-100', 'text-blue-700');
            btn.classList.add('bg-gray-100', 'text-gray-600');
        });
        
        const activeBtn = document.getElementById(`filter-${filter}`);
        if (activeBtn) {
            activeBtn.classList.remove('bg-gray-100', 'text-gray-600');
            activeBtn.classList.add('active', 'bg-blue-100', 'text-blue-700');
        }
        
        // Apply filter
        applyContentFilter();
    }

    function applyContentFilter() {
        const lectureItems = document.querySelectorAll('.lecture-item');
        const noteItems = document.querySelectorAll('.note-item');
        
        lectureItems.forEach(item => {
            const moduleIndex = parseInt(item.dataset.module);
            const lectureIndex = parseInt(item.dataset.lecture);
            const lectureId = `${moduleIndex}-${lectureIndex}`;
            const isCompleted = completedLectures.includes(lectureId);
            
            let show = true;
            
            switch (activeFilter) {
                case 'lectures':
                    show = true;
                    break;
                case 'notes':
                    show = false;
                    break;
                case 'completed':
                    show = isCompleted;
                    break;
                case 'all':
                default:
                    show = true;
                    break;
            }
            
            item.style.display = show ? 'flex' : 'none';
        });
        
        noteItems.forEach(item => {
            let show = true;
            
            switch (activeFilter) {
                case 'lectures':
                    show = false;
                    break;
                case 'notes':
                    show = true;
                    break;
                case 'completed':
                    show = false; // Notes don't have completion status
                    break;
                case 'all':
                default:
                    show = true;
                    break;
            }
            
            item.style.display = show ? 'flex' : 'none';
        });
        
        // Hide/show section headers based on content visibility
        document.querySelectorAll('.lectures-section').forEach(section => {
            const visibleLectures = section.querySelectorAll('.lecture-item[style*="flex"]');
            section.style.display = visibleLectures.length > 0 ? 'block' : 'none';
        });
        
        document.querySelectorAll('.notes-section').forEach(section => {
            const visibleNotes = section.querySelectorAll('.note-item[style*="flex"]');
            section.style.display = visibleNotes.length > 0 ? 'block' : 'none';
        });
    }

    function toggleModule(moduleId) {
        const moduleContent = document.getElementById(moduleId);
        const chevron = document.querySelector(`button[onclick="toggleModule('${moduleId}')"] .module-chevron`);
        
        if (moduleContent && chevron) {
            moduleContent.classList.toggle('hidden');
            chevron.classList.toggle('rotate-180');
        }
    }

    function toggleTheaterMode() {
        const sidebar = document.querySelector('.sidebar');
        const isTheaterMode = sidebar.classList.contains('hidden');
        
        if (isTheaterMode) {
            sidebar.classList.remove('hidden');
            showNotification('Theater mode disabled', 'info');
        } else {
            sidebar.classList.add('hidden');
            showNotification('Theater mode enabled', 'info');
        }
    }

    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen();
            showNotification('Entered fullscreen mode', 'info');
        } else {
            document.exitFullscreen();
            showNotification('Exited fullscreen mode', 'info');
        }
    }

    function openNotesModal() {
        const modal = document.getElementById('notes-modal');
        const textarea = document.getElementById('user-notes');
        
        if (currentModule !== -1 && currentLecture !== -1) {
            const noteKey = `${currentModule}-${currentLecture}`;
            textarea.value = userNotes[noteKey] || '';
            modal.classList.remove('hidden');
            textarea.focus();
        }
    }

    function closeNotesModal() {
        document.getElementById('notes-modal').classList.add('hidden');
    }

    function saveUserNotes() {
        if (currentModule !== -1 && currentLecture !== -1) {
            const noteKey = `${currentModule}-${currentLecture}`;
            const noteContent = document.getElementById('user-notes').value;
            
            userNotes[noteKey] = noteContent;
            saveUserNotesToStorage(new URLSearchParams(window.location.search).get('id'));
            
            closeNotesModal();
            showNotification('Notes saved successfully!', 'success');
        }
    }

    function loadLectureNotes(moduleIndex, lectureIndex) {
        const noteKey = `${moduleIndex}-${lectureIndex}`;
        const noteContent = userNotes[noteKey];
        
        if (noteContent) {
            // Could display user notes in the UI if desired
            console.log('User notes loaded for this lecture');
        }
    }

    function navigateToLecture(direction) {
        return function() {
            if (!currentCourse?.modules || currentModule === -1 || currentLecture === -1) return;
            
            const allLectures = [];
            currentCourse.modules.forEach((module, moduleIndex) => {
                module.lectures?.forEach((lecture, lectureIndex) => {
                    allLectures.push({ moduleIndex, lectureIndex });
                });
            });
            
            const currentIndex = allLectures.findIndex(
                item => item.moduleIndex === currentModule && item.lectureIndex === currentLecture
            );
            
            const nextIndex = currentIndex + direction;
            
            if (nextIndex >= 0 && nextIndex < allLectures.length) {
                const nextLecture = allLectures[nextIndex];
                selectContent(nextLecture.moduleIndex, nextLecture.lectureIndex, 'lecture');
            }
        };
    }

    function handleKeyboardShortcuts(e) {
        // Don't handle shortcuts when typing in inputs
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        
        switch (e.key) {
            case 'ArrowLeft':
                e.preventDefault();
                navigateToLecture(-1)();
                break;
            case 'ArrowRight':
                e.preventDefault();
                navigateToLecture(1)();
                break;
            case 'f':
            case 'F':
                e.preventDefault();
                toggleFullscreen();
                break;
            case 't':
            case 'T':
                e.preventDefault();
                toggleTheaterMode();
                break;
            case 'n':
            case 'N':
                e.preventDefault();
                openNotesModal();
                break;
            case 'Escape':
                closeNotesModal();
                break;
        }
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-20 right-6 z-50 px-4 py-3 rounded-lg shadow-lg transition-all transform translate-x-full`;
        
        const colors = {
            success: 'bg-green-500 text-white',
            error: 'bg-red-500 text-white',
            info: 'bg-blue-500 text-white',
            warning: 'bg-yellow-500 text-white'
        };
        
        notification.className += ` ${colors[type] || colors.info}`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // Animate in
        setTimeout(() => {
            notification.classList.remove('translate-x-full');
        }, 100);
        
        // Animate out and remove
        setTimeout(() => {
            notification.classList.add('translate-x-full');
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }

    // Global function assignments
    window.toggleModule = toggleModule;
    window.selectContent = selectContent;
    window.markLectureCompleted = markLectureCompleted;

    // Help tooltip
    function showKeyboardShortcuts() {
        const helpText = `
        Keyboard Shortcuts:
        • ← / → : Navigate between lectures
        • F : Toggle fullscreen
        • T : Toggle theater mode
        • N : Take notes
        • ESC : Close modals
        `;
        showNotification(helpText, 'info');
    }

    // Add help button to floating controls
    document.addEventListener('DOMContentLoaded', () => {
        const floatingControls = document.querySelector('.floating-controls');
        if (floatingControls) {
            const helpBtn = document.createElement('button');
            helpBtn.className = 'p-3 rounded-full shadow-lg hover:shadow-xl transition-all bg-white';
            helpBtn.innerHTML = `
                <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                </svg>
            `;
            helpBtn.onclick = showKeyboardShortcuts;
            floatingControls.appendChild(helpBtn);
        }
    });
    </script>

    <script src="firebase.js"></script>
    <script src="script.js"></script>
</body>
</html>
