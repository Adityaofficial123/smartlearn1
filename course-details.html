<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Details - SmartLearn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Force high-contrast text for all major elements */
        body, .text-gray-700, .text-gray-600, .text-gray-500, .text-white, .text-blue-600, .text-green-800, .text-green-600, .text-blue-700, .text-lg, .text-xl, .text-2xl, .text-3xl, .text-4xl, .text-5xl, .font-bold, .font-semibold, .font-medium, .opacity-75, .opacity-90 {
            color: #1f2937 !important;
        }
        .bg-gradient-to-r.from-blue-600.to-purple-600, .bg-gradient-to-r {
            color: #fff !important;
        }
        .text-white, .bg-white, .bg-green-100, .bg-blue-600, .bg-blue-700, .bg-green-600, .bg-green-800 {
            color: #1f2937 !important;
        }
        .text-blue-600, .text-blue-700 {
            color: #2563eb !important;
        }
        .text-green-600, .text-green-800 {
            color: #059669 !important;
        }
        .text-center, .text-sm, .text-xs {
            color: #1f2937 !important;
        }
        .opacity-75, .opacity-90 {
            opacity: 1 !important;
        }
        /* Sidebar price */
        #course-price {
            color: #2563eb !important;
        }
        /* Enrollment status */
        #enrollment-status {
            color: #059669 !important;
        }
        /* Modal text */
        #login-modal, #login-modal * {
            color: #1f2937 !important;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg fixed w-full z-50" style="color:#1f2937;">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="index.html" class="text-2xl font-bold text-blue-600">SmartLearn</a>
                </div>
                
                <div class="hidden md:flex items-center space-x-8">
                    <a href="index.html" class="text-gray-700 hover:text-blue-600 transition-colors">Home</a>
                    <a href="courses.html" class="text-gray-700 hover:text-blue-600 transition-colors">Courses</a>
                    <a href="my-courses.html" class="text-gray-700 hover:text-blue-600 transition-colors">My Learning</a>
                </div>

                <div class="flex items-center space-x-4">
                    <div id="auth-buttons" class="flex items-center space-x-2">
                        <button id="login-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            Login with Google
                        </button>
                    </div>
                    <div id="user-info" class="hidden flex items-center space-x-2">
                        <span id="user-name" class="text-gray-700 font-medium"></span>
                        <button id="logout-btn" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition-colors">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Course Details -->
    <section class="pt-16">
        <div id="loading" class="text-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-gray-600">Loading course details...</p>
        </div>

        <div id="course-content" class="hidden">
            <!-- Course Header -->
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white py-16">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="grid md:grid-cols-2 gap-8 items-center">
                        <div>
                            <h1 id="course-title" class="text-4xl md:text-5xl font-bold mb-4" style="color:#fff;"> </h1>
                            <p id="course-description" class="text-xl mb-6" style="color:#fff;"></p>
                            <div class="flex items-center space-x-4 mb-6">
                                <div class="flex items-center">
                                    <div id="course-rating" class="flex text-yellow-400 mr-2" style="color:#fde047;"></div>
                                    <span id="rating-text" class="text-sm" style="color:#fff;"></span>
                                </div>
                                <span id="course-students" class="text-sm" style="color:#fff;"></span>
                            </div>
                            <p class="text-lg" style="color:#fff;">By <span id="course-instructor" class="font-semibold" style="color:#fff;"></span></p>
                        </div>
                        <div class="text-center">
                            <img id="course-image" src="" alt="Course" class="rounded-lg shadow-2xl max-w-full h-auto">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Course Info -->
            <div class="py-12">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="grid lg:grid-cols-3 gap-8">
                        <!-- Main Content -->
                        <div class="lg:col-span-2">
                            <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
                                <h2 class="text-2xl font-bold mb-4">What you'll learn</h2>
                                <ul id="course-objectives" class="space-y-2">
                                    <!-- Objectives will be loaded dynamically -->
                                </ul>
                            </div>

                            <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
                                <h2 class="text-2xl font-bold mb-4">Course Content</h2>
                                <div id="course-curriculum" class="space-y-4">
                                    <!-- Curriculum will be loaded dynamically -->
                                </div>
                            </div>

                            <div class="bg-white rounded-lg shadow-lg p-8">
                                <h2 class="text-2xl font-bold mb-4">About the Instructor</h2>
                                <div class="flex items-start space-x-4">
                                    <img id="instructor-image" src="" alt="Instructor" class="w-16 h-16 rounded-full">
                                    <div>
                                        <h3 id="instructor-name" class="text-xl font-semibold mb-2"></h3>
                                        <p id="instructor-bio" class="text-gray-600"></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sidebar -->
                        <div>
                            <div class="bg-white rounded-lg shadow-lg p-8 sticky top-24">
                                <div class="text-center mb-6">
                                    <div id="price-section">
                                        <span id="course-price" class="text-3xl font-bold text-blue-600"></span>
                                    </div>
                                </div>

                                <button id="enroll-btn" class="w-full bg-blue-600 text-white py-4 px-6 rounded-lg text-lg font-semibold hover:bg-blue-700 transition-colors mb-4 disabled:opacity-50 disabled:cursor-not-allowed">
                                    Enroll Now
                                </button>

                                <div id="enrollment-status" class="hidden text-center p-4 bg-green-100 text-green-800 rounded-lg mb-4">
                                    ✓ You are enrolled in this course
                                </div>

                                <div class="space-y-4 text-sm text-gray-600">
                                    <div class="flex justify-between">
                                        <span>Duration:</span>
                                        <span id="course-duration"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Level:</span>
                                        <span id="course-level"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Category:</span>
                                        <span id="course-category"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Language:</span>
                                        <span>English</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Certificate:</span>
                                        <span>Yes</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold mb-6 text-center">Welcome to SmartLearn</h2>
            <button id="google-login" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Continue with Google
            </button>
            <button id="close-modal" class="mt-4 w-full text-gray-500 hover:text-gray-700">Close</button>
        </div>
    </div>

    <!-- Load scripts in correct order -->
    <script src="firebase.js"></script>
    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let currentCourse = null;
            let currentUser = null;

            const urlParams = new URLSearchParams(window.location.search);
            const courseId = urlParams.get('id');

            // Check if course ID exists, redirect if not
            if (!courseId) {
                alert('No course selected. Redirecting to courses page.');
                window.location.href = 'courses.html';
                return;
            }

            function waitForFirebaseInit(callback) {
                const interval = setInterval(() => {
                    if (window.firebaseServicesInitialized && typeof window.db === 'function') {
                        clearInterval(interval);
                        callback();
                    }
                }, 100);
            }

            async function loadCourseDetails() {
                try {
                    console.log('Loading course details for ID:', courseId);
                    
                    const courseDoc = await window.db().collection('courses').doc(courseId).get();
                    
                    if (!courseDoc.exists) {
                        throw new Error('Course not found');
                    }

                    currentCourse = { id: courseDoc.id, ...courseDoc.data() };
                    console.log('Course loaded:', currentCourse);
                    
                    displayCourseDetails(currentCourse);
                    afterCourseLoaded();
                } catch (error) {
                    console.error('Error loading course:', error);
                    alert('Error loading course details. Redirecting to courses page.');
                    window.location.href = 'courses.html';
                }
            }

            async function checkEnrollmentStatus() {
                if (!currentUser || !currentCourse) return;
                
                try {
                    const snapshot = await window.db().collection('enrollments')
                        .where('userId', '==', currentUser.uid)
                        .where('courseId', '==', currentCourse.id)
                        .get();
                    
                    if (!snapshot.empty) {
                        document.getElementById('enroll-btn').style.display = 'none';
                        document.getElementById('enrollment-status').classList.remove('hidden');
                    }
                } catch (err) {
                    console.error('Error checking enrollment:', err);
                }
            }

            function displayCourseDetails(course) {
                try {
                    // Set basic course info
                    document.getElementById('course-title').textContent = course.title || 'Course Title';
                    document.getElementById('course-description').textContent = course.description || 'Course description';
                    document.getElementById('course-instructor').textContent = course.instructor || 'Instructor';
                    document.getElementById('course-duration').textContent = course.duration || 'N/A';
                    document.getElementById('course-level').textContent = course.level || 'All levels';
                    document.getElementById('course-category').textContent = course.category || 'General';

                    // Set course image
                    const courseImage = document.getElementById('course-image');
                    if (course.image) {
                        courseImage.src = course.image;
                        courseImage.alt = course.title || 'Course Image';
                    }

                    // Set rating
                    const ratingElement = document.getElementById('course-rating');
                    ratingElement.innerHTML = generateStarRating(course.rating || 0);
                    document.getElementById('rating-text').textContent = `${course.rating || "0.0"} (${course.reviews || 0} reviews)`;
                    document.getElementById('course-students').textContent = `${course.students || 0} students`;

                    // Set price
                    const priceElement = document.getElementById('course-price');
                    if (course.price === 0) {
                        priceElement.textContent = 'Free';
                        priceElement.className = 'text-3xl font-bold text-green-600';
                    } else {
                        priceElement.textContent = `$${course.price || '0'}`;
                        priceElement.className = 'text-3xl font-bold text-blue-600';
                    }

                    // Set objectives
                    const objectivesContainer = document.getElementById('course-objectives');
                    if (course.objectives && Array.isArray(course.objectives)) {
                        objectivesContainer.innerHTML = course.objectives.map(obj =>
                            `<li class="flex items-start"><span class="text-green-500 mr-2">✓</span>${obj}</li>`
                        ).join('');
                    } else {
                        objectivesContainer.innerHTML = '<li class="text-gray-500">Course objectives will be updated soon.</li>';
                    }

                    // Set curriculum
                    const curriculumContainer = document.getElementById('course-curriculum');
                    if (course.curriculum && Array.isArray(course.curriculum)) {
                        curriculumContainer.innerHTML = course.curriculum.map((section, index) =>
                            `<div class="border border-gray-200 rounded-lg p-4">
                                <h3 class="font-semibold text-lg mb-2">Section ${index + 1}: ${section.title || 'Course Section'}</h3>
                                <p class="text-gray-600 mb-2">${section.description || 'Section description'}</p>
                                <div class="text-sm text-gray-500">${section.lessons || '0'} lessons • ${section.duration || 'N/A'}</div>
                            </div>`
                        ).join('');
                    } else {
                        curriculumContainer.innerHTML = '<div class="text-gray-500">Course curriculum will be updated soon.</div>';
                    }

                    // Set instructor info
                    document.getElementById('instructor-name').textContent = course.instructor || 'Instructor';
                    const instructorImage = document.getElementById('instructor-image');
                    instructorImage.src = course.instructorImage || 'https://images.pexels.com/photos/614810/pexels-photo-614810.jpeg?auto=compress&cs=tinysrgb&w=400';
                    instructorImage.alt = course.instructor || 'Instructor';
                    document.getElementById('instructor-bio').textContent = course.instructorBio || 'Experienced instructor with years of industry experience.';

                    // Show course content and hide loading
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('course-content').classList.remove('hidden');

                } catch (error) {
                    console.error('Error displaying course details:', error);
                    alert('Error displaying course information.');
                }
            }

            function generateStarRating(rating) {
                const fullStars = Math.floor(rating);
                const hasHalfStar = rating % 1 >= 0.5;
                const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
                let stars = '';

                // Full stars
                for (let i = 0; i < fullStars; i++) {
                    stars += '⭐';
                }

                // Half star
                if (hasHalfStar) {
                    stars += '⭐'; // Using full star for half star for simplicity
                }

                // Empty stars
                for (let i = 0; i < emptyStars; i++) {
                    stars += '☆';
                }

                return stars;
            }

            function enableEnrollBtn() {
                const enrollBtn = document.getElementById('enroll-btn');
                enrollBtn.disabled = false;
                enrollBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }

            function disableEnrollBtn() {
                const enrollBtn = document.getElementById('enroll-btn');
                enrollBtn.disabled = true;
                enrollBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }

            function afterCourseLoaded() {
                checkEnrollmentStatus();
                if (currentUser && currentCourse) {
                    enableEnrollBtn();
                }
            }

            // Set up authentication listener
            function setupAuthListener() {
                firebase.auth().onAuthStateChanged(user => {
                    console.log('Auth state changed:', user ? user.email : 'No user');
                    currentUser = user;
                    window.currentUser = user;
                    
                    // Update UI based on auth state
                    updateAuthUI(user);
                    
                    if (user && currentCourse) {
                        enableEnrollBtn();
                        checkEnrollmentStatus();
                    } else if (!user) {
                        disableEnrollBtn();
                    }
                });
            }

            // Set up enroll button event listener
            function setupEnrollButton() {
                const enrollBtn = document.getElementById('enroll-btn');
                
                enrollBtn.addEventListener('click', async function () {
                    if (!currentUser) {
                        showLoginModal();
                        return;
                    }
                    
                    if (!currentCourse) {
                        alert('Course information not loaded. Please refresh the page.');
                        return;
                    }

                    // Disable button and show loading state
                    enrollBtn.disabled = true;
                    enrollBtn.textContent = 'Enrolling...';

                    try {
                        // Check if DatabaseAPI exists
                        if (!window.DatabaseAPI) {
                            throw new Error('Database API not available');
                        }

                        await window.DatabaseAPI.enrollInCourse(
                            currentUser.uid,
                            currentCourse.id,
                            currentUser.displayName || 'Student',
                            currentUser.email || ''
                        );

                        enrollBtn.textContent = 'Enrolled!';
                        setTimeout(() => {
                            enrollBtn.style.display = 'none';
                            document.getElementById('enrollment-status').classList.remove('hidden');
                        }, 1000);

                    } catch (error) {
                        console.error('Enrollment error:', error);
                        
                        // Check if enrollment actually exists (in case of duplicate error)
                        try {
                            const snapshot = await window.db().collection('enrollments')
                                .where('userId', '==', currentUser.uid)
                                .where('courseId', '==', currentCourse.id)
                                .get();
                            
                            if (!snapshot.empty) {
                                enrollBtn.textContent = 'Enrolled!';
                                setTimeout(() => {
                                    enrollBtn.style.display = 'none';
                                    document.getElementById('enrollment-status').classList.remove('hidden');
                                }, 1000);
                                return;
                            }
                        } catch (e) {
                            console.error('Error checking enrollment status:', e);
                        }

                        // Re-enable button and show error
                        enrollBtn.textContent = 'Enroll Now';
                        enableEnrollBtn();
                        alert('Failed to enroll in course. Please try again.');
                    }
                });
            }

            // Wait for Firebase to initialize
            function waitForFirebaseAndSetup() {
                const interval = setInterval(() => {
                    if (window.firebaseServicesInitialized) {
                        clearInterval(interval);
                        setupAuthListener();
                        setupEnrollButton();
                        loadCourseDetails();
                    }
                }, 100);
            }

            // Initialize everything
            disableEnrollBtn(); // Start with button disabled
            waitForFirebaseAndSetup();
        });
    </script>
</body>
</html>